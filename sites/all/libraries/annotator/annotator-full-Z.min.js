!function(){var t,e,n,o,i,r,s,a,u,l,h,p,d,c,f,g,m,v,y,_,w,T,b,E,C,A,N,k,F=[].slice,x={}.hasOwnProperty,O=function(t,e){function n(){this.constructor=t}for(var o in e)x.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},S=function(t,e){return function(){return t.apply(e,arguments)}},P=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(v=function(e){var n;return n=this.map(function(){var n,o,i,r;for(i="",n=this;(null!=n?n.nodeType:void 0)===Node.ELEMENT_NODE&&n!==e;)r=n.tagName.replace(":","\\:"),o=t(n.parentNode).children(r).index(n)+1,o="["+o+"]",i="/"+n.tagName.toLowerCase()+o+i,n=n.parentNode;return i}),n.get()},y=function(t){var e,n,o,i;return e=function(t){var e,n;return e=c(t),n=f(t),""+e+"["+n+"]"},i=t,n=function(t){var n;for(n="";t!==i;){if(null==t)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+i);n=e(t)+"/"+n,t=t.parentNode}return n="/"+n,n=n.replace(/\/$/,"")},o=this.map(function(){var t;return t=n(this)}),o.get()},l=function(t,e,n){var o,i,r,s,a,u;if(!t.hasChildNodes())throw new Error("XPath error: node has no children!");for(i=t.childNodes,r=0,a=0,u=i.length;u>a;a++)if(o=i[a],s=c(o),s===e&&(r+=1,r===n))return o;throw new Error("XPath error: wanted child not found.")},c=function(t){var e;switch(e=t.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},f=function(t){var e,n;for(e=0,n=t;n;)n.nodeName===t.nodeName&&e++,n=n.previousSibling;return e},g=null,"undefined"!=typeof Gettext&&null!==Gettext?(w=new Gettext({domain:"annotator"}),g=function(t){return w.gettext(t)}):g=function(t){return t},k=function(t){return g(t)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(A=jQuery.fn)?A.jquery:void 0)||console.error(k("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(k("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),t=jQuery,r={},r.flatten=function(e){var n;return(n=function(e){var o,i,r,s;for(i=[],r=0,s=e.length;s>r;r++)o=e[r],i=i.concat(o&&t.isArray(o)?n(o):o);return i})(e)},r.contains=function(t,e){var n;for(n=e;null!=n;){if(n===t)return!0;n=n.parentNode}return!1},r.getTextNodes=function(t){var e;return e=function(t){var n;if(t&&t.nodeType!==Node.TEXT_NODE){if(n=[],t.nodeType!==Node.COMMENT_NODE)for(t=t.lastChild;t;)n.push(e(t)),t=t.previousSibling;return n.reverse()}return t},t.map(function(){return r.flatten(e(this))})},r.getLastTextNodeUpTo=function(t){var e;switch(t.nodeType){case Node.TEXT_NODE:return t;case Node.ELEMENT_NODE:if(null!=t.lastChild&&(e=r.getLastTextNodeUpTo(t.lastChild),null!=e))return e}return t=t.previousSibling,null!=t?r.getLastTextNodeUpTo(t):null},r.getFirstTextNodeNotBefore=function(t){var e;switch(t.nodeType){case Node.TEXT_NODE:return t;case Node.ELEMENT_NODE:if(null!=t.firstChild&&(e=r.getFirstTextNodeNotBefore(t.firstChild),null!=e))return e}return t=t.nextSibling,null!=t?r.getFirstTextNodeNotBefore(t):null},r.readRangeViaSelection=function(t){var e;return e=r.getGlobal().getSelection(),e.removeAllRanges(),e.addRange(t.toRange()),e.toString()},r.xpathFromNode=function(t,e){var n,o;try{o=v.call(t,e)}catch(i){n=i,console.log("jQuery-based XPath construction failed! Falling back to manual."),o=y.call(t,e)}return o},r.nodeFromXPath=function(t,e){var n,o,i,r,s,a,u,h;for(s=t.substring(1).split("/"),i=e,a=0,u=s.length;u>a;a++)r=s[a],h=r.split("["),o=h[0],n=h[1],n=null!=n?parseInt((null!=n?n.split("]"):void 0)[0]):1,i=l(i,o.toLowerCase(),n);return i},r.escape=function(t){return t.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},r.uuid=function(){var t;return t=0,function(){return t++}}(),r.getGlobal=function(){return function(){return this}()},r.maxZIndex=function(e){var n,o;return n=function(){var n,i,r;for(r=[],n=0,i=e.length;i>n;n++)o=e[n],r.push("static"===t(o).css("position")?-1:parseInt(t(o).css("z-index"),10)||-1);return r}(),Math.max.apply(Math,n)},r.mousePosition=function(e,n){var o,i;return"absolute"!==(i=t(n).css("position"))&&"fixed"!==i&&"relative"!==i&&(n=t(n).offsetParent()[0]),o=t(n).offset(),{top:e.pageY-o.top,left:e.pageX-o.left}},r.preventEventDefault=function(t){return null!=t&&"function"==typeof t.preventDefault?t.preventDefault():void 0},p=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(t){return console.log("GROUP: ",t)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),T=0,E=p.length;E>T;T++)h=p[T],null==console[h]&&(console[h]=function(){return console.log(k("Not implemented:")+(" console."+name))});else{for(this.console={},b=0,C=p.length;C>b;b++)h=p[b],this.console[h]=function(){};this.console.error=function(){var t;return t=1<=arguments.length?F.call(arguments,0):[],alert("ERROR: "+t.join(", "))},this.console.warn=function(){var t;return t=1<=arguments.length?F.call(arguments,0):[],alert("WARNING: "+t.join(", "))}}n=function(){function e(e,n){this.options=t.extend(!0,{},this.options,n),this.element=t(e),this._closures={},this.on=this.subscribe,this.addEvents()}return e.prototype.events={},e.prototype.options={},e.prototype.element=null,e.prototype.addEvents=function(){var t,n,o,i,r;for(i=e._parseEvents(this.events),r=[],n=0,o=i.length;o>n;n++)t=i[n],r.push(this._addEvent(t.selector,t.event,t.functionName));return r},e.prototype.removeEvents=function(){var t,n,o,i,r;for(i=e._parseEvents(this.events),r=[],n=0,o=i.length;o>n;n++)t=i[n],r.push(this._removeEvent(t.selector,t.event,t.functionName));return r},e.prototype._addEvent=function(t,n,o){var i;return i=function(t){return function(){return t[o].apply(t,arguments)}}(this),""===t&&e._isCustomEvent(n)?this.subscribe(n,i):this.element.delegate(t,n,i),this._closures[""+t+"/"+n+"/"+o]=i,this},e.prototype._removeEvent=function(t,n,o){var i;return i=this._closures[""+t+"/"+n+"/"+o],""===t&&e._isCustomEvent(n)?this.unsubscribe(n,i):this.element.undelegate(t,n,i),delete this._closures[""+t+"/"+n+"/"+o],this},e.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},e.prototype.subscribe=function(e,n){var o;return o=function(){return n.apply(this,[].slice.call(arguments,1))},o.guid=n.guid=t.guid+=1,this.element.bind(e,o),this},e.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},e}(),n._parseEvents=function(t){var e,n,o,i,r,s,a;n=[];for(i in t)o=t[i],a=i.split(" "),r=2<=a.length?F.call(a,0,s=a.length-1):(s=0,[]),e=a[s++],n.push({selector:r.join(" "),event:e,functionName:o});return n},n.natives=function(){var t,e,n;return e=function(){var e,o;e=jQuery.event.special,o=[];for(t in e)x.call(e,t)&&(n=e[t],o.push(t));return o}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(e)}(),n._isCustomEvent=function(e){return e=e.split(".")[0],-1===t.inArray(e,n.natives)},i={},i.sniff=function(t){return null!=t.commonAncestorContainer?new i.BrowserRange(t):"string"==typeof t.start?new i.SerializedRange(t):t.start&&"object"==typeof t.start?new i.NormalizedRange(t):(console.error(k("Could not sniff range type")),!1)},i.nodeFromXPath=function(e,n){var o,i,s,a,u;return null==n&&(n=document),i=function(t,e){var o;null==e&&(e=null);try{return document.evaluate("."+t,n,e,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(i){return o=i,console.log("XPath evaluation failed."),console.log("Trying fallback..."),r.nodeFromXPath(t,n)}},t.isXMLDoc(document.documentElement)?(o=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),a=i(e,o),a||(e=function(){var t,n,o,i;for(o=e.split("/"),i=[],t=0,n=o.length;n>t;t++)u=o[t],i.push(u&&-1===u.indexOf(":")?u.replace(/^([a-z]+)/,"xhtml:$1"):u);return i}().join("/"),s=document.lookupNamespaceURI(null),o=function(t){return"xhtml"===t?s:document.documentElement.getAttribute("xmlns:"+t)},a=i(e,o)),a):i(e)},i.RangeError=function(t){function e(t,n,o){this.type=t,this.message=n,this.parent=null!=o?o:null,e.__super__.constructor.call(this,this.message)}return O(e,t),e}(Error),i.BrowserRange=function(){function t(t){this.commonAncestorContainer=t.commonAncestorContainer,this.startContainer=t.startContainer,this.startOffset=t.startOffset,this.endContainer=t.endContainer,this.endOffset=t.endOffset}return t.prototype.normalize=function(){var t,e,n,o;if(this.tainted)return console.error(k("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,o={},this.startContainer.nodeType===Node.ELEMENT_NODE?(o.start=r.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),o.startOffset=0):(o.start=this.startContainer,o.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(e=this.endContainer.childNodes[this.endOffset],null!=e){for(t=e;null!=t&&t.nodeType!==Node.TEXT_NODE;)t=t.firstChild;null!=t&&(o.end=t,o.endOffset=0)}null==o.end&&(e=this.endContainer.childNodes[this.endOffset-1],o.end=r.getLastTextNodeUpTo(e),o.endOffset=o.end.nodeValue.length)}else o.end=this.endContainer,o.endOffset=this.endOffset;for(n={},n.start=o.startOffset>0?o.start.nodeValue.length>o.startOffset?o.start.splitText(o.startOffset):o.start.nextSibling:o.start,o.start===o.end?(n.start.nodeValue.length>o.endOffset-o.startOffset&&n.start.splitText(o.endOffset-o.startOffset),n.end=n.start):(o.end.nodeValue.length>o.endOffset&&o.end.splitText(o.endOffset),n.end=o.end),n.commonAncestor=this.commonAncestorContainer;n.commonAncestor.nodeType!==Node.ELEMENT_NODE;)n.commonAncestor=n.commonAncestor.parentNode;return new i.NormalizedRange(n)},t.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},t}(),i.NormalizedRange=function(){function e(t){this.commonAncestor=t.commonAncestor,this.start=t.start,this.end=t.end}return e.prototype.normalize=function(){return this},e.prototype.limit=function(e){var n,o,i,r,s,a;if(n=t.grep(this.textNodes(),function(n){return n.parentNode===e||t.contains(e,n.parentNode)}),!n.length)return null;for(this.start=n[0],this.end=n[n.length-1],i=t(this.start).parents(),a=t(this.end).parents(),r=0,s=a.length;s>r;r++)if(o=a[r],-1!==i.index(o)){this.commonAncestor=o;break}return this},e.prototype.serialize=function(e,n){var o,s,a;return s=function(o,i){var s,a,u,l,h,p,d,c;for(l=n?t(o).parents(":not("+n+")").eq(0):t(o).parent(),p=r.xpathFromNode(l,e)[0],h=r.getTextNodes(l),a=h.slice(0,h.index(o)),u=0,d=0,c=a.length;c>d;d++)s=a[d],u+=s.nodeValue.length;return i?[p,u+o.nodeValue.length]:[p,u]},a=s(this.start),o=s(this.end,!0),new i.SerializedRange({start:a[0],end:o[0],startOffset:a[1],endOffset:o[1]})},e.prototype.text=function(){var t;return function(){var e,n,o,i;for(o=this.textNodes(),i=[],e=0,n=o.length;n>e;e++)t=o[e],i.push(t.nodeValue);return i}.call(this).join("")},e.prototype.textNodes=function(){var e,n,o,i;return o=r.getTextNodes(t(this.commonAncestor)),i=[o.index(this.start),o.index(this.end)],n=i[0],e=i[1],t.makeArray(o.slice(n,+e+1||9e9))},e.prototype.toRange=function(){var t;return t=document.createRange(),t.setStartBefore(this.start),t.setEndAfter(this.end),t},e}(),i.SerializedRange=function(){function e(t){this.start=t.start,this.startOffset=t.startOffset,this.end=t.end,this.endOffset=t.endOffset}return e.prototype.normalize=function(e){var n,o,s,a,u,l,h,p,d,c,f,g,m,v;for(l={},m=["start","end"],d=0,f=m.length;f>d;d++){u=m[d];try{a=i.nodeFromXPath(this[u],e)}catch(y){throw o=y,new i.RangeError(u,"Error while finding "+u+" node: "+this[u]+": "+o,o)}if(!a)throw new i.RangeError(u,"Couldn't find "+u+" node: "+this[u]);for(s=0,h=this[u+"Offset"],"end"===u&&h--,v=r.getTextNodes(t(a)),c=0,g=v.length;g>c;c++){if(p=v[c],s+p.nodeValue.length>h){l[u+"Container"]=p,l[u+"Offset"]=this[u+"Offset"]-s;break}s+=p.nodeValue.length}if(null==l[u+"Offset"])throw new i.RangeError(""+u+"offset","Couldn't find offset "+this[u+"Offset"]+" in element "+this[u])}return n=null==document.compareDocumentPosition?function(t,e){return t.contains(e)}:function(t,e){return 16&t.compareDocumentPosition(e)},t(l.startContainer).parents().each(function(){return n(this,l.endContainer)?(l.commonAncestorContainer=this,!1):void 0}),new i.BrowserRange(l).normalize(e)},e.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},e.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},e}(),_=this.Annotator,e=function(e){function n(){return this.onDeleteAnnotation=S(this.onDeleteAnnotation,this),this.onEditAnnotation=S(this.onEditAnnotation,this),this.onAdderClick=S(this.onAdderClick,this),this.onAdderMousedown=S(this.onAdderMousedown,this),this.onHighlightMouseover=S(this.onHighlightMouseover,this),this.checkForEndSelection=S(this.checkForEndSelection,this),this.checkForStartSelection=S(this.checkForStartSelection,this),this.clearViewerHideTimer=S(this.clearViewerHideTimer,this),this.startViewerHideTimer=S(this.startViewerHideTimer,this),this.showViewer=S(this.showViewer,this),this.onEditorSubmit=S(this.onEditorSubmit,this),this.onEditorHide=S(this.onEditorHide,this),this.showEditor=S(this.showEditor,this),n.__super__.constructor.apply(this,arguments),this.plugins={},n.supported()?(this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=t(this.html.adder).appendTo(this.wrapper).hide(),void n._instances.push(this)):this}return O(n,e),n.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},n.prototype.html={adder:'<div class="annotator-adder"><button>'+k("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},n.prototype.options={readOnly:!1},n.prototype.plugins={},n.prototype.editor=null,n.prototype.viewer=null,n.prototype.selectedRanges=null,n.prototype.mouseIsDown=!1,n.prototype.ignoreMouseup=!1,n.prototype.viewerHideTimer=null,n.prototype._setupWrapper=function(){return this.wrapper=t(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},n.prototype._setupViewer=function(){return this.viewer=new n.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(e){return function(n,o){return t(n).html(o.text?r.escape(o.text):"<i>"+k("No Comment")+"</i>"),e.publish("annotationViewerTextField",[n,o])}}(this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},n.prototype._setupEditor=function(){return this.editor=new n.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:k("Comments")+"…",load:function(e,n){return t(e).find("textarea").val(n.text||"")},submit:function(e,n){return n.text=t(e).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},n.prototype._setupDocumentEvents=function(){return t(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},n.prototype._setupDynamicStyle=function(){var e,n,o,i;return o=t("#annotator-dynamic-style"),o.length||(o=t('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),n="*"+function(){var t,e,n,o;for(n=["adder","outer","notice","filter"],o=[],t=0,e=n.length;e>t;t++)i=n[t],o.push(":not(.annotator-"+i+")");return o}().join(""),e=r.maxZIndex(t(document.body).find(n)),e=Math.max(e,1e3),o.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(e+20)+";","}",".annotator-filter {","  z-index: "+(e+10)+";","}"].join("\n")),this},n.prototype.destroy=function(){var e,o,i,r;t(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),t("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return t(this).contents().insertBefore(this),t(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),r=this.plugins;for(o in r)i=r[o],this.plugins[o].destroy();return this.removeEvents(),e=n._instances.indexOf(this),-1!==e?n._instances.splice(e,1):void 0},n.prototype.getSelectedRanges=function(){var e,n,o,s,a,u,l,h,p;for(l=r.getGlobal().getSelection(),a=[],u=[],l.isCollapsed||(a=function(){var t,r,a;for(a=[],n=t=0,r=l.rangeCount;r>=0?r>t:t>r;n=r>=0?++t:--t)s=l.getRangeAt(n),e=new i.BrowserRange(s),o=e.normalize().limit(this.wrapper[0]),null===o&&u.push(s),a.push(o);return a}.call(this),l.removeAllRanges()),h=0,p=u.length;p>h;h++)s=u[h],l.addRange(s);return t.grep(a,function(t){return t&&l.addRange(t.toRange()),t})},n.prototype.createAnnotation=function(){var t;return t={},this.publish("beforeAnnotationCreated",[t]),t},n.prototype.setupAnnotation=function(e){var n,o,r,s,a,u,l,h,p,d;for(a=this.wrapper[0],e.ranges||(e.ranges=this.selectedRanges),r=[],d=e.ranges,u=0,h=d.length;h>u;u++){s=d[u];try{r.push(i.sniff(s).normalize(a))}catch(c){if(n=c,!(n instanceof i.RangeError))throw n;this.publish("rangeNormalizeFail",[e,s,n])}}for(e.quote=[],e.ranges=[],e.highlights=[],l=0,p=r.length;p>l;l++)o=r[l],e.quote.push(t.trim(o.text())),e.ranges.push(o.serialize(this.wrapper[0],".annotator-hl")),t.merge(e.highlights,this.highlightRange(o));return e.quote=e.quote.join(" / "),t(e.highlights).data("annotation",e),e},n.prototype.updateAnnotation=function(t){return this.publish("beforeAnnotationUpdated",[t]),this.publish("annotationUpdated",[t]),t},n.prototype.deleteAnnotation=function(e){var n,o,i,r,s;if(null!=e.highlights)for(s=e.highlights,i=0,r=s.length;r>i;i++)o=s[i],null!=o.parentNode&&(n=o.childNodes[0],t(o).replaceWith(o.childNodes));return this.publish("annotationDeleted",[e]),e},n.prototype.loadAnnotations=function(t){var e,n;return null==t&&(t=[]),n=function(t){return function(o){var i,r,s,a;for(null==o&&(o=[]),r=o.splice(0,10),s=0,a=r.length;a>s;s++)i=r[s],t.setupAnnotation(i);return o.length>0?setTimeout(function(){return n(o)},10):t.publish("annotationsLoaded",[e])}}(this),e=t.slice(),n(t),this},n.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(k("Can't dump annotations without Store plugin.")),!1)},n.prototype.highlightRange=function(e,n){var o,i,r,s,a,u,l;for(null==n&&(n="annotator-hl"),r=/^\s*$/,o=t("<span class='"+n+"'></span>"),u=e.textNodes(),l=[],s=0,a=u.length;a>s;s++)i=u[s],r.test(i.nodeValue)||l.push(t(i).wrapAll(o).parent().show()[0]);return l},n.prototype.highlightRanges=function(e,n){var o,i,r,s;for(null==n&&(n="annotator-hl"),o=[],r=0,s=e.length;s>r;r++)i=e[r],t.merge(o,this.highlightRange(i,n));return o},n.prototype.addPlugin=function(t,e){var o,i;return this.plugins[t]?console.error(k("You cannot have more than one instance of any plugin.")):(o=n.Plugin[t],"function"==typeof o?(this.plugins[t]=new o(this.element[0],e),this.plugins[t].annotator=this,"function"==typeof(i=this.plugins[t]).pluginInit&&i.pluginInit()):console.error(k("Could not load ")+t+k(" plugin. Have you included the appropriate <script> tag?"))),this},n.prototype.showEditor=function(t,e){return this.editor.element.css(e),this.editor.load(t),this.publish("annotationEditorShown",[this.editor,t]),this},n.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},n.prototype.onEditorSubmit=function(t){return this.publish("annotationEditorSubmit",[this.editor,t])},n.prototype.showViewer=function(t,e){return this.viewer.element.css(e),this.viewer.load(t),this.publish("annotationViewerShown",[this.viewer,t])},n.prototype.startViewerHideTimer=function(){return this.viewerHideTimer?void 0:this.viewerHideTimer=setTimeout(this.viewer.hide,250)},n.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},n.prototype.checkForStartSelection=function(t){return t&&this.isAnnotator(t.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},n.prototype.checkForEndSelection=function(e){var n,o,i,s,a;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),a=this.selectedRanges,i=0,s=a.length;s>i;i++)if(o=a[i],n=o.commonAncestor,t(n).hasClass("annotator-hl")&&(n=t(n).parents("[class!=annotator-hl]")[0]),this.isAnnotator(n))return;return e&&this.selectedRanges.length?this.adder.css(r.mousePosition(e,this.wrapper[0])).show():this.adder.hide()}},n.prototype.isAnnotator=function(e){return!!t(e).parents().addBack().filter("[class^=annotator-]").not(this.wrapper).length},n.prototype.onHighlightMouseover=function(e){var n;return this.clearViewerHideTimer(),this.mouseIsDown||this.viewer.isShown()?!1:(n=t(e.target).parents(".annotator-hl").addBack().map(function(){return t(this).data("annotation")}),this.showViewer(t.makeArray(n),r.mousePosition(e,this.wrapper[0])))},n.prototype.onAdderMousedown=function(t){return null!=t&&t.preventDefault(),this.ignoreMouseup=!0},n.prototype.onAdderClick=function(e){var n,o,i,r,s;return null!=e&&e.preventDefault(),r=this.adder.position(),this.adder.hide(),n=this.setupAnnotation(this.createAnnotation()),t(n.highlights).addClass("annotator-hl-temporary"),s=function(e){return function(){return i(),t(n.highlights).removeClass("annotator-hl-temporary"),e.publish("annotationCreated",[n])}}(this),o=function(t){return function(){return i(),t.deleteAnnotation(n)}}(this),i=function(t){return function(){return t.unsubscribe("annotationEditorHidden",o),t.unsubscribe("annotationEditorSubmit",s)}}(this),this.subscribe("annotationEditorHidden",o),this.subscribe("annotationEditorSubmit",s),this.showEditor(n,r)},n.prototype.onEditAnnotation=function(t){var e,n,o;return n=this.viewer.element.position(),o=function(n){return function(){return e(),n.updateAnnotation(t)}}(this),e=function(t){return function(){return t.unsubscribe("annotationEditorHidden",e),t.unsubscribe("annotationEditorSubmit",o)}}(this),this.subscribe("annotationEditorHidden",e),this.subscribe("annotationEditorSubmit",o),this.viewer.hide(),this.showEditor(t,n)},n.prototype.onDeleteAnnotation=function(t){return this.viewer.hide(),this.deleteAnnotation(t)},n}(n),e.Plugin=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return O(e,t),e.prototype.pluginInit=function(){},e.prototype.destroy=function(){return this.removeEvents()},e}(n),d=r.getGlobal(),null==(null!=(N=d.document)?N.evaluate:void 0)&&t.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==d.getSelection&&t.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==d.JSON&&t.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==d.Node&&(d.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),e.$=t,e.Delegator=n,e.Range=i,e.Util=r,e._instances=[],e._t=k,e.supported=function(){return function(){return!!this.getSelection}()},e.noConflict=function(){return r.getGlobal().Annotator=_,this},t.fn.annotator=function(n){var o;return o=Array.prototype.slice.call(arguments,1),this.each(function(){var i;return i=t.data(this,"annotator"),i?n&&i[n].apply(i,o):(i=new e(this,n),t.data(this,"annotator",i))})},this.Annotator=e,e.Widget=function(n){function o(){o.__super__.constructor.apply(this,arguments),this.classes=t.extend({},e.Widget.prototype.classes,this.classes)}return O(o,n),o.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},o.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},o.prototype.checkOrientation=function(){var n,o,i,r,s;return this.resetOrientation(),s=t(e.Util.getGlobal()),r=this.element.children(":first"),o=r.offset(),i={top:s.scrollTop(),right:s.width()+s.scrollLeft()},n={top:o.top,right:o.left+r.width()},n.top-i.top<0&&this.invertY(),n.right-i.right>0&&this.invertX(),this},o.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},o.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},o.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},o.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},o.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},o}(n),e.Editor=function(n){function o(e){this.onCancelButtonMouseover=S(this.onCancelButtonMouseover,this),this.processKeypress=S(this.processKeypress,this),this.submit=S(this.submit,this),this.load=S(this.load,this),this.hide=S(this.hide,this),this.show=S(this.show,this),o.__super__.constructor.call(this,t(this.html)[0],e),this.fields=[],this.annotation={}}return O(o,n),o.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},o.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},o.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+k("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+k("Save")+"</a>\n    </div>\n  </form>\n</div>",o.prototype.options={},o.prototype.show=function(t){return e.Util.preventEventDefault(t),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},o.prototype.hide=function(t){return e.Util.preventEventDefault(t),this.element.addClass(this.classes.hide),this.publish("hide")},o.prototype.load=function(t){var e,n,o,i;for(this.annotation=t,this.publish("load",[this.annotation]),i=this.fields,n=0,o=i.length;o>n;n++)e=i[n],e.load(e.element,this.annotation);return this.show()},o.prototype.submit=function(t){var n,o,i,r;for(e.Util.preventEventDefault(t),r=this.fields,o=0,i=r.length;i>o;o++)n=r[o],n.submit(n.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},o.prototype.addField=function(n){var o,i,r;switch(i=t.extend({id:"annotator-field-"+e.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},n),r=null,o=t('<li class="annotator-item" />'),i.element=o[0],i.type){case"textarea":r=t("<textarea />");break;case"input":case"checkbox":r=t("<input />");break;case"select":r=t("<select />")}return o.append(r),r.attr({id:i.id,placeholder:i.label}),"checkbox"===i.type&&(r[0].type="checkbox",o.addClass("annotator-checkbox"),o.append(t("<label />",{"for":i.id,html:i.label}))),this.element.find("ul:first").append(o),this.fields.push(i),i.element},o.prototype.checkOrientation=function(){var t,e;return o.__super__.checkOrientation.apply(this,arguments),e=this.element.find("ul"),t=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?t.insertBefore(e):t.is(":first-child")&&t.insertAfter(e),this},o.prototype.processKeypress=function(t){return 27===t.keyCode?this.hide():13!==t.keyCode||t.shiftKey?void 0:this.submit()},o.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},o.prototype.setupDraggables=function(){var e,n,o,i,r,s,a,u,l,h,p;return this.element.find(".annotator-resize").remove(),o=this.element.find(this.element.hasClass(this.classes.invert.y)?".annotator-item:last":".annotator-item:first"),o&&t('<span class="annotator-resize"></span>').appendTo(o),r=null,e=this.classes,i=this.element,h=null,l=i.find(".annotator-resize"),n=i.find(".annotator-controls"),p=!1,s=function(e){return e.target===this?(r={element:this,top:e.pageY,left:e.pageX},h=i.find("textarea:first"),t(window).bind({"mouseup.annotator-editor-resize":u,"mousemove.annotator-editor-resize":a}),e.preventDefault()):void 0},u=function(){return r=null,t(window).unbind(".annotator-editor-resize")},a=function(){return function(t){var o,s,a,u,d;return r&&p===!1?(o={top:t.pageY-r.top,left:t.pageX-r.left},r.element===l[0]?(u=h.outerHeight(),d=h.outerWidth(),s=i.hasClass(e.invert.x)?-1:1,a=i.hasClass(e.invert.y)?1:-1,h.height(u+o.top*a),h.width(d+o.left*s),h.outerHeight()!==u&&(r.top=t.pageY),h.outerWidth()!==d&&(r.left=t.pageX)):r.element===n[0]&&(i.css({top:parseInt(i.css("top"),10)+o.top,left:parseInt(i.css("left"),10)+o.left}),r.top=t.pageY,r.left=t.pageX),p=!0,setTimeout(function(){return p=!1},1e3/60)):void 0}}(this),l.bind("mousedown",s),n.bind("mousedown",s)},o}(e.Widget),e.Viewer=function(n){function i(e){this.onDeleteClick=S(this.onDeleteClick,this),this.onEditClick=S(this.onEditClick,this),this.load=S(this.load,this),this.hide=S(this.hide,this),this.show=S(this.show,this),i.__super__.constructor.call(this,t(this.html.element)[0],e),this.item=t(this.html.item)[0],this.fields=[],this.annotations=[]}return O(i,n),i.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},i.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},i.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},i.prototype.options={readOnly:!1},i.prototype.show=function(t){var n;return e.Util.preventEventDefault(t),n=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(t){return function(){return n.removeClass(t.classes.showControls)}}(this),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},i.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},i.prototype.hide=function(t){return e.Util.preventEventDefault(t),this.element.addClass(this.classes.hide),this.publish("hide")},i.prototype.load=function(e){var n,i,r,s,a,u,l,h,p,d,c,f,g,m,v,y,_;for(this.annotations=e||[],c=this.element.find("ul:first").empty(),y=this.annotations,f=0,m=y.length;m>f;f++)for(n=y[f],h=t(this.item).clone().appendTo(c).data("annotation",n),r=h.find(".annotator-controls"),p=r.find(".annotator-link"),a=r.find(".annotator-edit"),s=r.find(".annotator-delete"),d=new o(n.links||[]).get("alternate",{type:"text/html"}),0===d.length||null==d[0].href?p.remove():p.attr("href",d[0].href),this.options.readOnly?(a.remove(),s.remove()):i={showEdit:function(){return a.removeAttr("disabled")},hideEdit:function(){return a.attr("disabled","disabled")},showDelete:function(){return s.removeAttr("disabled")},hideDelete:function(){return s.attr("disabled","disabled")}},_=this.fields,g=0,v=_.length;v>g;g++)l=_[g],u=t(l.element).clone().appendTo(h)[0],l.load(u,n,i);return this.publish("load",[this.annotations]),this.show()
},i.prototype.addField=function(e){var n;return n=t.extend({load:function(){}},e),n.element=t("<div />")[0],this.fields.push(n),n.element,this},i.prototype.onEditClick=function(t){return this.onButtonClick(t,"edit")},i.prototype.onDeleteClick=function(t){return this.onButtonClick(t,"delete")},i.prototype.onButtonClick=function(e,n){var o;return o=t(e.target).parents(".annotator-annotation"),this.publish(n,[o.data("annotation")])},i}(e.Widget),o=function(){function e(t){this.data=t}return e.prototype.get=function(e,n){var o,i,r,s,a,u,l,h,p;for(null==n&&(n={}),n=t.extend({},n,{rel:e}),r=function(){var t;t=[];for(i in n)x.call(n,i)&&(a=n[i],t.push(i));return t}(),h=this.data,p=[],u=0,l=h.length;l>u;u++)o=h[u],s=r.reduce(function(t,e){return t&&o[e]===n[e]},!0),s&&p.push(o);return p},e}(),e=e||{},e.Notification=function(n){function o(e){this.hide=S(this.hide,this),this.show=S(this.show,this),o.__super__.constructor.call(this,t(this.options.html).appendTo(document.body)[0],e)}return O(o,n),o.prototype.events={click:"hide"},o.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},o.prototype.show=function(n,o){return null==o&&(o=e.Notification.INFO),this.currentStatus=o,t(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(r.escape(n||"")),setTimeout(this.hide,5e3),this},o.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=e.Notification.INFO),t(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},o}(n),e.Notification.INFO="info",e.Notification.SUCCESS="success",e.Notification.ERROR="error",t(function(){var t;return t=new e.Notification,e.showNotification=t.show,e.hideNotification=t.hide}),e.Plugin.Unsupported=function(n){function o(){return o.__super__.constructor.apply(this,arguments)}return O(o,n),o.prototype.options={message:e._t("Sorry your current browser does not support the Annotator")},o.prototype.pluginInit=function(){return e.supported()?void 0:t(function(n){return function(){return e.showNotification(n.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject?t("html").addClass("ie6"):void 0}}(this))},o}(e.Plugin),u=function(t){var e,n,o,i,r,s;return i="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",e=t.match(new RegExp(i)),o=0,n=new Date(e[1],0,1),e[3]&&n.setMonth(e[3]-1),e[5]&&n.setDate(e[5]),e[7]&&n.setHours(e[7]),e[8]&&n.setMinutes(e[8]),e[10]&&n.setSeconds(e[10]),e[12]&&n.setMilliseconds(1e3*Number("0."+e[12])),e[14]&&(o=60*Number(e[16])+Number(e[17]),o*=null!=(s="-"===e[15])?s:{1:-1}),o-=n.getTimezoneOffset(),r=Number(n)+60*o*1e3,n.setTime(Number(r)),n},s=function(t){var e,n,o,i,r,s,a,u,l,h,p,d,c;if("undefined"!=typeof atob&&null!==atob)return atob(t);if(n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,e=0,i="",c=[],!t)return t;for(t+="";l<t.length;)r=n.indexOf(t.charAt(l++)),s=n.indexOf(t.charAt(l++)),a=n.indexOf(t.charAt(l++)),u=n.indexOf(t.charAt(l++)),o=r<<18|s<<12|a<<6|u,h=o>>16&255,p=o>>8&255,d=255&o,c[e++]=64===a?String.fromCharCode(h):64===u?String.fromCharCode(h,p):String.fromCharCode(h,p,d);return c.join("")},a=function(t){var e,n,o,i;if(n=t.length%4,0!==n)for(e=o=0,i=4-n;i>=0?i>o:o>i;e=i>=0?++o:--o)t+="=";return t=t.replace(/-/g,"+"),t=t.replace(/_/g,"/"),s(t)},m=function(t){var e,n,o,i;return i=t.split("."),e=i[0],n=i[1],o=i[2],JSON.parse(a(n))},e.Plugin.Auth=function(n){function o(){o.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return O(o,n),o.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},o.prototype.requestToken=function(){return this.requestInProgress=!0,t.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(t){return function(e){return t.setToken(e)}}(this)).fail(function(){return function(t,n,o){var i;return i=e._t("Couldn't get auth token:"),console.error(""+i+" "+o,t),e.showNotification(""+i+" "+t.responseText,e.Notification.ERROR)}}(this)).always(function(t){return function(){return t.requestInProgress=!1}}(this))},o.prototype.setToken=function(t){var n;if(this.token=t,this._unsafeToken=m(t),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(t){return function(){return t.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),n=[];this.waitingForToken.length>0;)n.push(this.waitingForToken.pop()(this._unsafeToken));return n}return console.warn(e._t("Didn't get a valid token.")),this.options.autoFetch?(console.warn(e._t("Getting a new token in 10s.")),setTimeout(function(t){return function(){return t.requestToken()}}(this),1e4)):void 0},o.prototype.haveValidToken=function(){var t;return t=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,t&&this.timeToExpiry()>0?!0:!1},o.prototype.timeToExpiry=function(){var t,e,n,o;return n=(new Date).getTime()/1e3,e=u(this._unsafeToken.issuedAt).getTime()/1e3,t=e+this._unsafeToken.ttl,o=t-n,o>0?o:0},o.prototype.updateHeaders=function(){var e;return e=this.element.data("annotator:headers"),this.element.data("annotator:headers",t.extend(e,{"x-annotator-auth-token":this.token}))},o.prototype.withToken=function(t){return null!=t?this.haveValidToken()?t(this._unsafeToken):(this.waitingForToken.push(t),this.requestInProgress?void 0:this.requestToken()):void 0},o}(e.Plugin),e.Plugin.Store=function(n){function o(){this._onError=S(this._onError,this),this._onLoadAnnotationsFromSearch=S(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=S(this._onLoadAnnotations,this),this._getAnnotations=S(this._getAnnotations,this),o.__super__.constructor.apply(this,arguments),this.annotations=[]}return O(o,n),o.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},o.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},o.prototype.pluginInit=function(){return e.supported()?this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations():void 0},o.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},o.prototype.annotationCreated=function(t){return P.call(this.annotations,t)<0?(this.registerAnnotation(t),this._apiRequest("create",t,function(n){return function(o){return null==o.id&&console.warn(e._t("Warning: No ID returned from server for annotation "),t),n.updateAnnotation(t,o)}}(this))):this.updateAnnotation(t,{})},o.prototype.annotationUpdated=function(t){return P.call(this.annotations,t)>=0?this._apiRequest("update",t,function(e){return function(n){return e.updateAnnotation(t,n)}}(this)):void 0},o.prototype.annotationDeleted=function(t){return P.call(this.annotations,t)>=0?this._apiRequest("destroy",t,function(e){return function(){return e.unregisterAnnotation(t)}}(this)):void 0},o.prototype.registerAnnotation=function(t){return this.annotations.push(t)},o.prototype.unregisterAnnotation=function(t){return this.annotations.splice(this.annotations.indexOf(t),1)},o.prototype.updateAnnotation=function(n,o){return P.call(this.annotations,n)<0?console.error(e._t("Trying to update unregistered annotation!")):t.extend(n,o),t(n.highlights).data("annotation",n)},o.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},o.prototype._onLoadAnnotations=function(t){var e,n,o,i,r,s,a,u,l;for(null==t&&(t=[]),o={},l=this.annotations,r=0,a=l.length;a>r;r++)e=l[r],o[e.id]=e;for(i=[],s=0,u=t.length;u>s;s++)e=t[s],o[e.id]?(n=o[e.id],this.updateAnnotation(n,e)):i.push(e);return this.annotations=this.annotations.concat(i),this.annotator.loadAnnotations(i.slice())},o.prototype.loadAnnotationsFromSearch=function(t){return this._apiRequest("search",t,this._onLoadAnnotationsFromSearch)},o.prototype._onLoadAnnotationsFromSearch=function(t){return null==t&&(t={}),this._onLoadAnnotations(t.rows||[])},o.prototype.dumpAnnotations=function(){var t,e,n,o,i;for(o=this.annotations,i=[],e=0,n=o.length;n>e;e++)t=o[e],i.push(JSON.parse(this._dataFor(t)));return i},o.prototype._apiRequest=function(e,n,o){var i,r,s,a;return i=n&&n.id,a=this._urlFor(e,i),r=this._apiRequestOptions(e,n,o),s=t.ajax(a,r),s._id=i,s._action=e,s},o.prototype._apiRequestOptions=function(e,n,o){var i,r,s;return r=this._methodFor(e),s={type:r,headers:this.element.data("annotator:headers"),dataType:"json",success:o||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==r&&"DELETE"!==r||(s.headers=t.extend(s.headers,{"X-HTTP-Method-Override":r}),s.type="POST"),"search"===e?s=t.extend(s,{data:n}):(i=n&&this._dataFor(n),this.options.emulateJSON?(s.data={json:i},this.options.emulateHTTP&&(s.data._method=r),s):s=t.extend(s,{data:i,contentType:"application/json; charset=utf-8"}))},o.prototype._urlFor=function(t,e){var n;return n=null!=this.options.prefix?this.options.prefix:"",n+=this.options.urls[t],n=n.replace(/\/:id/,null!=e?"/"+e:""),n=n.replace(/:id/,null!=e?e:"")},o.prototype._methodFor=function(t){var e;return e={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},e[t]},o.prototype._dataFor=function(e){var n,o;return o=e.highlights,delete e.highlights,t.extend(e,this.options.annotationData),n=JSON.stringify(e),o&&(e.highlights=o),n},o.prototype._onError=function(t){var n,o;switch(n=t._action,o=e._t("Sorry we could not ")+n+e._t(" this annotation"),"search"===t._action?o=e._t("Sorry we could not search the store for annotations"):"read"!==t._action||t._id||(o=e._t("Sorry we could not ")+n+e._t(" the annotations from the store")),t.status){case 401:o=e._t("Sorry you are not allowed to ")+n+e._t(" this annotation");break;case 404:o=e._t("Sorry we could not connect to the annotations store");break;case 500:o=e._t("Sorry something went wrong with the annotation store")}return e.showNotification(o,e.Notification.ERROR),console.error(e._t("API request failed:")+(" '"+t.status+"'"))},o}(e.Plugin),e.Plugin.Permissions=function(n){function o(){this._setAuthFromToken=S(this._setAuthFromToken,this),this.updateViewer=S(this.updateViewer,this),this.updateAnnotationPermissions=S(this.updateAnnotationPermissions,this),this.updatePermissionsField=S(this.updatePermissionsField,this),this.addFieldsToAnnotation=S(this.addFieldsToAnnotation,this),o.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return O(o,n),o.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},o.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(t){return t},userString:function(t){return t},userAuthorize:function(t,e,n){var o,i,r,s;if(e.permissions){if(i=e.permissions[t]||[],0===i.length)return!0;for(r=0,s=i.length;s>r;r++)if(o=i[r],this.userId(n)===o)return!0;return!1}return e.user?n?this.userId(n)===this.userId(e.user):!1:!0},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}},o.prototype.pluginInit=function(){var t,n;if(e.supported())return n=this,t=function(t,e){return function(o,i){return n[t].call(n,e,o,i)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),this.options.showViewPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:e._t("Allow anyone to <strong>view</strong> this annotation"),load:t("updatePermissionsField","read"),submit:t("updateAnnotationPermissions","read")}),this.options.showEditPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:e._t("Allow anyone to <strong>edit</strong> this annotation"),load:t("updatePermissionsField","update"),submit:t("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:e._t("User"),property:"user",isFiltered:function(t){return function(e,n){var o,i,r,s;if(n=t.options.userString(n),!e||!n)return!1;for(s=e.split(/\s*/),i=0,r=s.length;r>i;i++)if(o=s[i],-1===n.indexOf(o))return!1;return!0}}(this)}):void 0},o.prototype.setUser=function(t){return this.user=t},o.prototype.addFieldsToAnnotation=function(t){return t&&(t.permissions=this.options.permissions,this.user)?t.user=this.user:void 0},o.prototype.authorize=function(t,e,n){return void 0===n&&(n=this.user),this.options.userAuthorize?this.options.userAuthorize.call(this.options,t,e,n):!0},o.prototype.updatePermissionsField=function(e,n,o){var i;return n=t(n).show(),i=n.find("input").removeAttr("disabled"),this.authorize("admin",o)||n.hide(),this.authorize(e,o||{},null)?i.attr("checked","checked"):i.removeAttr("checked")},o.prototype.updateAnnotationPermissions=function(e,n,o){var i;return o.permissions||(o.permissions=this.options.permissions),i=e+"-permissions",o.permissions[e]=t(n).find("input").is(":checked")?[]:[this.options.userId(this.user)]},o.prototype.updateViewer=function(n,o,i){var r,s;return n=t(n),s=this.options.userString(o.user),o.user&&s&&"string"==typeof s?(r=e.Util.escape(this.options.userString(o.user)),n.html(r).addClass("annotator-user")):n.remove(),i&&(this.authorize("update",o)||i.hideEdit(),!this.authorize("delete",o))?i.hideDelete():void 0},o.prototype._setAuthFromToken=function(t){return this.setUser(t.userId)},o}(e.Plugin),e.Plugin.AnnotateItPermissions=function(e){function n(){return this._setAuthFromToken=S(this._setAuthFromToken,this),this.updateAnnotationPermissions=S(this.updateAnnotationPermissions,this),this.updatePermissionsField=S(this.updatePermissionsField,this),this.addFieldsToAnnotation=S(this.addFieldsToAnnotation,this),n.__super__.constructor.apply(this,arguments)}return O(n,e),n.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(t){return t.userId},userString:function(t){return t.userId},userAuthorize:function(t,e,n){var o,i,r,s,a,u;return i=e.permissions||{},o=i[t]||[],r=this.groups.world,P.call(o,r)>=0?!0:null!=n&&null!=n.userId&&null!=n.consumerKey?n.userId===e.user&&n.consumerKey===e.consumer?!0:(s=this.groups.authenticated,P.call(o,s)>=0?!0:n.consumerKey===e.consumer&&(a=this.groups.consumer,P.call(o,a)>=0)?!0:n.consumerKey===e.consumer&&(u=n.userId,P.call(o,u)>=0)?!0:n.consumerKey===e.consumer&&n.admin?!0:!1):!1},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}},n.prototype.addFieldsToAnnotation=function(t){return t&&(t.permissions=this.options.permissions,this.user)?(t.user=this.user.userId,t.consumer=this.user.consumerKey):void 0},n.prototype.updatePermissionsField=function(e,n,o){var i;return n=t(n).show(),i=n.find("input").removeAttr("disabled"),this.authorize("admin",o)||n.hide(),this.user&&this.authorize(e,o||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?i.attr("checked","checked"):i.removeAttr("checked")},n.prototype.updateAnnotationPermissions=function(e,n,o){var i;return o.permissions||(o.permissions=this.options.permissions),i=e+"-permissions",o.permissions[e]=t(n).find("input").is(":checked")?["read"===e?this.options.groups.world:this.options.groups.consumer]:[]},n.prototype._setAuthFromToken=function(t){return this.setUser(t)},n}(e.Plugin.Permissions),e.Plugin.Filter=function(n){function o(e,n){this._onPreviousClick=S(this._onPreviousClick,this),this._onNextClick=S(this._onNextClick,this),this._onFilterKeyup=S(this._onFilterKeyup,this),this._onFilterBlur=S(this._onFilterBlur,this),this._onFilterFocus=S(this._onFilterFocus,this),this.updateHighlights=S(this.updateHighlights,this);var i;e=t(this.html.element).appendTo((null!=n?n.appendTo:void 0)||this.options.appendTo),o.__super__.constructor.call(this,e,n),(i=this.options).filters||(i.filters=[]),this.filter=t(this.html.filter),this.filters=[],this.current=0}return O(o,n),o.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},o.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},o.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+e._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+e._t("Previous")+'</button>\n<button class="annotator-filter-next">'+e._t("Next")+"</button>\n</span>\n<strong>"+e._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+e._t("Clear")+"</button>\n</span>"},o.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(t,e){var n,o,i,r;if(!t||!e)return!1;for(r=t.split(/\s+/),o=0,i=r.length;i>o;o++)if(n=r[o],-1===e.indexOf(n))return!1;return!0}},o.prototype.pluginInit=function(){var t,n,o,i;for(i=this.options.filters,n=0,o=i.length;o>n;n++)t=i[n],this.addFilter(t);return this.updateHighlights(),this._setupListeners()._insertSpacer(),this.options.addAnnotationFilter===!0?this.addFilter({label:e._t("Annotation"),property:"text"}):void 0},o.prototype.destroy=function(){var e,n;return o.__super__.destroy.apply(this,arguments),n=t("html"),e=parseInt(n.css("padding-top"),10)||0,n.css("padding-top",e-this.element.outerHeight()),this.element.remove()},o.prototype._insertSpacer=function(){var e,n;return n=t("html"),e=parseInt(n.css("padding-top"),10)||0,n.css("padding-top",e+this.element.outerHeight()),this},o.prototype._setupListeners=function(){var t,e,n,o;for(e=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],n=0,o=e.length;o>n;n++)t=e[n],this.annotator.subscribe(t,this.updateHighlights);return this},o.prototype.addFilter=function(n){var o,i;return i=t.extend({label:"",property:"",isFiltered:this.options.isFiltered},n),function(){var t,e,n,r;for(n=this.filters,r=[],t=0,e=n.length;e>t;t++)o=n[t],o.property===i.property&&r.push(o);return r}.call(this).length||(i.id="annotator-filter-"+i.property,i.annotations=[],i.element=this.filter.clone().appendTo(this.element),i.element.find("label").html(i.label).attr("for",i.id),i.element.find("input").attr({id:i.id,placeholder:e._t("Filter by ")+i.label+"…"}),i.element.find("button").hide(),i.element.data("filter",i),this.filters.push(i)),this},o.prototype.updateFilter=function(e){var n,o,i,r,s,a,u;if(e.annotations=[],this.updateHighlights(),this.resetHighlights(),i=t.trim(e.element.find("input").val())){for(o=this.highlights.map(function(){return t(this).data("annotation")}),u=t.makeArray(o),s=0,a=u.length;a>s;s++)n=u[s],r=n[e.property],e.isFiltered(i,r)&&e.annotations.push(n);return this.filterHighlights()}},o.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},o.prototype.filterHighlights=function(){var e,n,o,i,r,s,a,u,l,h;for(e=t.grep(this.filters,function(t){return!!t.annotations.length}),i=(null!=(h=e[0])?h.annotations:void 0)||[],e.length>1&&(o=[],t.each(e,function(){return t.merge(o,this.annotations)}),a=[],i=[],t.each(o,function(){return-1===t.inArray(this,a)?a.push(this):i.push(this)})),r=this.highlights,s=u=0,l=i.length;l>u;s=++u)n=i[s],r=r.not(n.highlights);return r.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},o.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},o.prototype._onFilterFocus=function(e){var n;return n=t(e.target),n.parent().addClass(this.classes.active),n.next("button").show()},o.prototype._onFilterBlur=function(e){var n;return e.target.value?void 0:(n=t(e.target),n.parent().removeClass(this.classes.active),n.next("button").hide())},o.prototype._onFilterKeyup=function(e){var n;return n=t(e.target).parent().data("filter"),n?this.updateFilter(n):void 0},o.prototype._findNextHighlight=function(t){var e,n,o,i,r,s,a,u;return this.highlights.length?(s=t?0:-1,u=t?-1:0,a=t?"lt":"gt",e=this.highlights.not("."+this.classes.hl.hide),o=e.filter("."+this.classes.hl.active),o.length||(o=e.eq(s)),n=o.data("annotation"),i=e.index(o[0]),r=e.filter(":"+a+"("+i+")").not(n.highlights).eq(u),r.length||(r=e.eq(u)),this._scrollToHighlight(r.data("annotation").highlights)):this},o.prototype._onNextClick=function(){return this._findNextHighlight()},o.prototype._onPreviousClick=function(){return this._findNextHighlight(!0)},o.prototype._scrollToHighlight=function(e){return e=t(e),this.highlights.removeClass(this.classes.hl.active),e.addClass(this.classes.hl.active),t("html, body").animate({scrollTop:e.offset().top-(this.element.height()+20)},150)},o.prototype._onClearClick=function(e){return t(e.target).prev("input").val("").keyup().blur()},o}(e.Plugin),e.Plugin.Markdown=function(n){function o(){this.updateTextField=S(this.updateTextField,this),null!=("undefined"!=typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(o.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(e._t("To use the Markdown plugin, you must include Showdown into the page first."))}return O(o,n),o.prototype.events={annotationViewerTextField:"updateTextField"},o.prototype.updateTextField=function(n,o){var i;return i=e.Util.escape(o.text||""),t(n).html(this.convert(i))},o.prototype.convert=function(t){return this.converter.makeHtml(t)},o}(e.Plugin),e.Plugin.Tags=function(n){function o(){return this.setAnnotationTags=S(this.setAnnotationTags,this),this.updateField=S(this.updateField,this),o.__super__.constructor.apply(this,arguments)}return O(o,n),o.prototype.options={parseTags:function(e){var n;return e=t.trim(e),n=[],e&&(n=e.split(/\s+/)),n},stringifyTags:function(t){return t.join(" ")}},o.prototype.field=null,o.prototype.input=null,o.prototype.pluginInit=function(){return e.supported()?(this.field=this.annotator.editor.addField({label:e._t("Add some tags here")+"…",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:e._t("Tag"),property:"tags",isFiltered:e.Plugin.Tags.filterCallback}),this.input=t(this.field).find(":input")):void 0},o.prototype.parseTags=function(t){return this.options.parseTags(t)},o.prototype.stringifyTags=function(t){return this.options.stringifyTags(t)},o.prototype.updateField=function(t,e){var n;return n="",e.tags&&(n=this.stringifyTags(e.tags)),this.input.val(n)},o.prototype.setAnnotationTags=function(t,e){return e.tags=this.parseTags(this.input.val())},o.prototype.updateViewer=function(n,o){return n=t(n),o.tags&&t.isArray(o.tags)&&o.tags.length?n.addClass("annotator-tags").html(function(){var n;return n=t.map(o.tags,function(t){return'<span class="annotator-tag">'+e.Util.escape(t)+"</span>"}).join(" ")}):n.remove()},o}(e.Plugin),e.Plugin.Tags.filterCallback=function(t,e){var n,o,i,r,s,a,u,l;if(null==e&&(e=[]),i=0,o=[],t)for(o=t.split(/\s+/g),s=0,u=o.length;u>s;s++)if(n=o[s],e.length)for(a=0,l=e.length;l>a;a++)r=e[a],-1!==r.indexOf(n)&&(i+=1);return i===o.length},e.Plugin.Categories=function(n){function o(){return this.setAnnotationCategories=S(this.setAnnotationCategories,this),this.updateField=S(this.updateField,this),o.__super__.constructor.apply(this,arguments)}return O(o,n),o.prototype.options={parseCategories:function(e){var n;return e=t.trim(e),n=[],e&&(n=e.split(/\s+/)),n},stringifyCategories:function(t){return t.join(" ")}},o.prototype.field=null,o.prototype.input=null,o.prototype.pluginInit=function(){return e.supported()?(this.field=this.annotator.editor.addField({label:e._t("Add some categories here")+"…",load:this.updateField,submit:this.setAnnotationCategories}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:e._t("Category"),property:"categories",isFiltered:e.Plugin.Category.filterCallback}),this.input=t(this.field).find(":input")):void 0},o.prototype.parseCategories=function(t){return this.options.parseCategories(t)},o.prototype.stringifyCategories=function(t){return this.options.stringifyCategories(t)},o.prototype.updateField=function(t,e){var n;return n="",e.categories&&(n=this.stringifyCategories(e.categories)),this.input.val(n)},o.prototype.setAnnotationCategories=function(t,e){return e.categories=this.parseCategories(this.input.val())},o.prototype.updateViewer=function(n,o){return n=t(n),o.categories&&t.isArray(o.categories)&&o.categories.length?n.addClass("annotator-categories").html(function(){var n;return n=t.map(o.categories,function(t){return'<span class="annotator-category">'+e.Util.escape(t)+"</span>"}).join(" ")}):n.remove()},o}(e.Plugin),e.Plugin.Categories.filterCallback=function(t,e){var n,o,i,r,s,a,u,l;if(null==e&&(e=[]),i=0,o=[],t)for(o=t.split(/\s+/g),s=0,u=o.length;u>s;s++)if(n=o[s],e.length)for(a=0,l=e.length;l>a;a++)r=e[a],-1!==r.indexOf(n)&&(i+=1);return i===o.length},e.prototype.setupPlugins=function(n,o){var i,r,s,a,u,l,h,p,d;null==n&&(n={}),null==o&&(o={}),l=e.Util.getGlobal(),a=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions","Categories"],l.Showdown&&a.push("Markdown"),u=l.location.href.split(/#|\?/).shift()||"",s={Tags:{},Filter:{filters:[{label:e._t("User"),property:"user"},{label:e._t("Tags"),property:"tags"}]},Auth:{tokenUrl:n.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:n.storeUrl||"http://annotateit.org/api",annotationData:{uri:u},loadFromSearch:{uri:u}}};for(i in o)x.call(o,i)&&(r=o[i],P.call(a,i)<0&&a.push(i));for(t.extend(!0,s,o),d=[],h=0,p=a.length;p>h;h++)i=a[h],d.push(i in s&&!s[i]?void 0:this.addPlugin(i,s[i]));return d}}.call(this);